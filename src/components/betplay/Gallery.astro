---
import BetplaySS1 from "@assets/screenshots/betplay1.png";
import BetplaySS2 from "@assets/screenshots/betplay2.png";
import BetplaySS3 from "@assets/screenshots/betplay3.png";
import BetplaySS4 from "@assets/screenshots/betplay4.png";
import BetplaySS5 from "@assets/screenshots/betplay5.png";
import { Image } from "astro:assets";

// Import Swiper styles
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';
import 'swiper/css/effect-fade';

const galleryItems = [
  { 
    id: 1, 
    src: BetplaySS1, 
    alt: "Dashboard principal de Betplay", 
    title: "Dashboard Principal",
    description: "Panel de control principal con métricas clave y acceso rápido a funcionalidades"
  },
  { 
    id: 2, 
    src: BetplaySS2, 
    alt: "Análisis de apuestas en tiempo real", 
    title: "Análisis en Tiempo Real",
    description: "Seguimiento en vivo de apuestas y estadísticas actualizadas al instante"
  },
  { 
    id: 3, 
    src: BetplaySS3, 
    alt: "Gestión de usuarios y permisos", 
    title: "Gestión de Usuarios",
    description: "Administración completa de perfiles, roles y permisos de acceso"
  },
  { 
    id: 4, 
    src: BetplaySS4, 
    alt: "Estadísticas detalladas", 
    title: "Estadísticas",
    description: "Informes detallados y análisis de rendimiento de la plataforma"
  },
  { 
    id: 5, 
    src: BetplaySS5, 
    alt: "Panel de administración", 
    title: "Administración",
    description: "Herramientas avanzadas para la gestión de la plataforma"
  },
];
---

<!-- Pass gallery items data to client-side -->
<div id="gallery-data" data-gallery-items={JSON.stringify(galleryItems)} class="hidden"></div>

<section id="gallery" class="py-16 md:py-24 bg-gradient-to-b from-white to-gray-50 relative overflow-hidden" data-component="gallery">
  <!-- Elementos decorativos -->
  <div class="absolute inset-0 opacity-5">
    <div class="absolute inset-0 bg-grid-gray-300 [mask-image:linear-gradient(0deg,white,transparent)]"></div>
  </div>
  
  <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12" id="gallery-header">
      <span class="inline-block text-sm font-semibold text-cyan-500 uppercase tracking-wider mb-3">
        Galería del Proyecto
      </span>
      <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
        Capturas de Pantalla
      </h2>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Una mirada interactiva a las características y funcionalidades implementadas en la plataforma.
      </p>
    </div>
    
    <!-- Main Swiper -->
    <div class="swiper-container relative mb-4 rounded-xl overflow-hidden shadow-2xl">
      <div class="swiper-wrapper">
        {galleryItems.map((item) => (
          <div class="swiper-slide bg-gray-100">
            <div class="relative pt-[56.25%] w-full">
              <Image 
                src={item.src} 
                alt={item.alt}
                class="absolute inset-0 w-full h-full object-contain"
                loading="lazy"
                width={1200}
                height={675}
                format="webp"
                quality={85}
              />
            </div>
          </div>
        ))}
      </div>
      <!-- Pagination -->
      <div class="swiper-pagination !bottom-2"></div>
    </div>
    
    <!-- Thumbnail Navigation -->
    <div class="mt-6 relative group">
      <!-- Navigation Arrows for Desktop -->
      <button 
        class="hidden md:flex absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 z-10 w-8 h-8 md:w-10 md:h-10 rounded-full bg-white dark:bg-gray-800 shadow-lg items-center justify-center text-gray-700 dark:text-gray-200 hover:bg-cyan-50 dark:hover:bg-cyan-900 transition-all duration-300 opacity-0 group-hover:opacity-100 focus:opacity-100 focus:outline-none"
        aria-label="Anterior miniatura"
        id="thumb-prev"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
      </button>
      
      <div class="relative overflow-hidden">
        <div 
          class="swiper-container-thumbs overflow-x-auto pb-4 -mx-2 px-2 scrollbar-hide snap-x snap-mandatory touch-pan-x"
          style="-webkit-overflow-scrolling: touch;"
          role="region"
          aria-label="Navegación de miniaturas"
          tabindex="0"
        >
          <div class="swiper-wrapper inline-flex min-h-[84px] items-center">
            {galleryItems.map((item, index) => (
              <div 
                class="swiper-slide !w-auto cursor-pointer opacity-50 hover:opacity-100 transition-all duration-200 px-1 flex-shrink-0 snap-start"
                role="button"
                tabindex="0"
                aria-label={`Ver imagen ${index + 1}: ${item.title}`}
                data-index={index}
                on:keydown={(e) => { if (e.key === 'Enter') swiper?.slideTo(index); }}
              >
                <div class="relative w-24 md:w-32 h-16 md:h-20 rounded-lg overflow-hidden border-2 border-transparent hover:border-cyan-400 transition-all duration-200 transform hover:scale-105">
                  <Image 
                    src={item.src} 
                    alt={item.alt}
                    class="absolute inset-0 w-full h-full object-cover"
                    loading="lazy"
                    width={150}
                    height={84}
                    format="webp"
                    quality={60}
                  />
                </div>
              </div>
            ))}
          </div>
        </div>
        <!-- Scroll Indicator -->
        <div class="w-full h-1 bg-gray-100 dark:bg-gray-700 rounded-full mt-2 overflow-hidden hidden md:block">
          <div id="scroll-progress" class="h-full bg-cyan-500 w-0 transition-all duration-300"></div>
        </div>
      </div>
      
      <!-- Navigation Arrows for Desktop -->
      <button 
        class="hidden md:flex absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 z-10 w-8 h-8 md:w-10 md:h-10 rounded-full bg-white dark:bg-gray-800 shadow-lg items-center justify-center text-gray-700 dark:text-gray-200 hover:bg-cyan-50 dark:hover:bg-cyan-900 transition-all duration-300 opacity-0 group-hover:opacity-100 focus:opacity-100 focus:outline-none"
        aria-label="Siguiente miniatura"
        id="thumb-next"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>
  
  <style>
    /* Custom Swiper styles */
    .swiper-container {
      --swiper-navigation-size: 24px;
      --swiper-navigation-color: white;
      --swiper-pagination-color: white;
      --swiper-pagination-bullet-size: 10px;
      --swiper-pagination-bullet-horizontal-gap: 6px;
    }
    
    .swiper-pagination-bullet {
      transition: all 0.3s ease;
      opacity: 0.7;
    }
    
    .swiper-pagination-bullet-active {
      width: 30px;
      border-radius: 4px;
      opacity: 1;
    }
    
    .swiper-slide-thumb-active {
      opacity: 1 !important;
      transform: scale(1.05);
    }
    
    .swiper-slide-thumb-active > div {
      border-color: #06b6d4 !important;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
    }
    
    /* Custom scrollbar for WebKit browsers */
    @media (hover: hover) {
      .scrollbar-hide::-webkit-scrollbar {
        height: 4px;
      }
      
      .scrollbar-hide::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
      }
      
      .scrollbar-hide::-webkit-scrollbar-thumb {
        background: rgba(6, 182, 212, 0.3);
        border-radius: 10px;
      }
      
      .scrollbar-hide::-webkit-scrollbar-thumb:hover {
        background: rgba(6, 182, 212, 0.5);
      }
    }
    
    /* Focus styles for accessibility */
    .swiper-slide:focus-visible {
      outline: 2px solid #06b6d4;
      outline-offset: 2px;
      border-radius: 0.5rem;
    }
  </style>
  
  <script>
    // Load Swiper on the client side
    document.addEventListener('DOMContentLoaded', async () => {
      // Get gallery items from data attribute
      const galleryData = document.getElementById('gallery-data');
      if (!galleryData) return;
      
      const galleryItems = JSON.parse(galleryData.dataset.galleryItems || '[]');
      
      // Dynamically import Swiper
      const Swiper = (await import('swiper/bundle')).default;
      
      // Initialize main swiper
      const swiper = new Swiper('.swiper-container', {
        loop: true,
        effect: 'fade',
        fadeEffect: {
          crossFade: true
        },
        speed: 1000,
        autoplay: {
          delay: 5000,
          disableOnInteraction: false,
          pauseOnMouseEnter: true,
          waitForTransition: true
        },
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
          dynamicBullets: true
        },
        thumbs: {
          swiper: null, // Will be initialized after
        },
      });
      
      // Initialize thumbs swiper with better touch support
      const thumbsSwiper = new Swiper('.swiper-container-thumbs', {
        spaceBetween: 8,
        slidesPerView: 'auto',
        freeMode: {
          enabled: true,
          sticky: false,
          momentumBounce: false,
        },
        watchSlidesProgress: true,
        breakpoints: {
          640: {
            spaceBetween: 10,
          },
          1024: {
            spaceBetween: 12,
          }
        },
        slideToClickedSlide: true,
        preventClicks: false,
        preventClicksPropagation: false,
        touchEventsTarget: 'wrapper',
        touchRatio: 0.5,
        touchAngle: 45,
        simulateTouch: true,
        shortSwipes: true,
        longSwipes: true,
        longSwipesRatio: 0.5,
        longSwipesMs: 300,
        followFinger: true,
        allowTouchMove: true,
        threshold: 5,
      });
      
      // Connect thumbs to main slider
      swiper.thumbs.swiper = thumbsSwiper;
      
      // Handle custom navigation
      document.getElementById('thumb-prev')?.addEventListener('click', () => {
        if (swiper.activeIndex > 0) {
          swiper.slidePrev();
        } else {
          swiper.slideTo(galleryItems.length - 1);
        }
      });
      
      document.getElementById('thumb-next')?.addEventListener('click', () => {
        if (swiper.activeIndex < galleryItems.length - 1) {
          swiper.slideNext();
        } else {
          swiper.slideTo(0);
        }
      });
      
      // Update scroll progress indicator
      const updateScrollProgress = () => {
        const container = document.querySelector('.swiper-container-thumbs');
        const progress = document.getElementById('scroll-progress');
        if (container && progress) {
          const { scrollWidth, clientWidth, scrollLeft } = container;
          const scrollPercentage = (scrollLeft / (scrollWidth - clientWidth)) * 100;
          progress.style.width = `${scrollPercentage}%`;
        }
      };
      
      // Initialize scroll progress
      updateScrollProgress();
      
      // Update progress on scroll
      const thumbContainer = document.querySelector('.swiper-container-thumbs');
      if (thumbContainer) {
        thumbContainer.addEventListener('scroll', updateScrollProgress, { passive: true });
      }
      
      // Handle keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (document.activeElement?.closest('.swiper-container-thumbs')) {
          const activeIndex = Array.from(document.querySelectorAll('.swiper-slide')).indexOf(document.activeElement);
          if (e.key === 'ArrowRight' && activeIndex < galleryItems.length - 1) {
            e.preventDefault();
            swiper.slideTo(activeIndex + 1);
          } else if (e.key === 'ArrowLeft' && activeIndex > 0) {
            e.preventDefault();
            swiper.slideTo(activeIndex - 1);
          } else if (e.key === 'Home') {
            e.preventDefault();
            swiper.slideTo(0);
          } else if (e.key === 'End') {
            e.preventDefault();
            swiper.slideTo(galleryItems.length - 1);
          }
        }
      });
      
      // Handle slide change to update active thumbnail
      swiper.on('slideChange', () => {
        const activeIndex = swiper.realIndex % galleryItems.length;
        const activeThumb = document.querySelector(`.swiper-container-thumbs .swiper-slide:nth-child(${activeIndex + 1})`);
        
        if (activeThumb) {
          // Remove active class from all thumbs
          document.querySelectorAll('.swiper-slide-thumb-active').forEach(el => {
            el.classList.remove('swiper-slide-thumb-active');
          });
          
          // Add active class to current thumb
          activeThumb.classList.add('swiper-slide-thumb-active');
          
          // Enhanced smooth scroll to active thumb with boundary check and visual feedback
          const container = document.querySelector('.swiper-container-thumbs');
          if (container) {
            // Remove active class from all thumbs first
            document.querySelectorAll('.swiper-slide-thumb-active').forEach(el => {
              el.classList.remove('swiper-slide-thumb-active');
            });
            
            // Add active class with a slight delay for better visual feedback
            setTimeout(() => {
              activeThumb.classList.add('swiper-slide-thumb-active');
            }, 50);
            
            // Calculate scroll position
            const containerRect = container.getBoundingClientRect();
            const thumbRect = activeThumb.getBoundingClientRect();
            const scrollLeft = container.scrollLeft;
            const thumbCenter = thumbRect.left - containerRect.left + thumbRect.width / 2 - containerRect.width / 2;
            
            // Add smooth scroll with requestAnimationFrame for better performance
            const start = performance.now();
            const duration = 400; // ms
            const startPos = scrollLeft;
            const distance = thumbCenter;
            
            const animateScroll = (currentTime) => {
              const elapsed = currentTime - start;
              const progress = Math.min(elapsed / duration, 1);
              const easeInOutCubic = progress < 0.5 
                ? 4 * progress * progress * progress 
                : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;
              
              container.scrollLeft = startPos + distance * easeInOutCubic;
              
              if (progress < 1) {
                requestAnimationFrame(animateScroll);
              }
            };
            
            requestAnimationFrame(animateScroll);
          }
        }
      });
      
      // Click on thumbnail to go to that slide
      document.querySelectorAll('.swiper-container-thumbs .swiper-slide').forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
          swiper.slideTo(index);
        });
      });
      
      // Add animation class to gallery when in view
      const gallery = document.querySelector('[data-component="gallery"]');
      const header = document.getElementById('gallery-header');
      
      if (gallery && header) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              header.classList.add('opacity-100', 'translate-y-0');
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.2 });
        
        observer.observe(gallery);
      }
    });
  </script>
</section>
